"""
Syst√®me d'√©v√©nements al√©atoires
"""

import random
from dataclasses import dataclass
from decimal import Decimal
from enum import Enum


class EventCategory(Enum):
    """Cat√©gories d'√©v√©nements."""

    WEATHER = "m√©t√©o"
    ECONOMIC = "√©conomique"
    SOCIAL = "social"
    COMPETITION = "concurrence"
    SUPPLY = "approvisionnement"
    REGULATION = "r√©glementation"


@dataclass
class RandomEvent:
    """√âv√©nement al√©atoire affectant le march√©."""

    id: str
    title: str
    description: str
    category: EventCategory
    probability: float  # 0.0 √† 1.0
    duration: int  # Nombre de tours

    # Effets sur le gameplay
    demand_multiplier: Decimal = Decimal("1.0")
    price_sensitivity: Decimal = Decimal("1.0")
    quality_importance: Decimal = Decimal("1.0")
    segment_effects: dict[str, Decimal] = None

    # Conditions d'activation
    min_turn: int = 1
    max_turn: int = 999
    season_required: str | None = None

    def __post_init__(self):
        if self.segment_effects is None:
            self.segment_effects = {}


class RandomEventManager:
    """Gestionnaire des √©v√©nements al√©atoires."""

    def __init__(self, random_seed: int | None = None):
        self.rng = random.Random(random_seed)
        self.active_events: list[RandomEvent] = []
        self.event_history: list[RandomEvent] = []
        self.events_pool = self._create_events_pool()

    def _create_events_pool(self) -> list[RandomEvent]:
        """Cr√©e la liste des √©v√©nements possibles."""
        return [
            # √âv√©nements m√©t√©orologiques
            RandomEvent(
                id="heatwave",
                title="üå°Ô∏è Canicule",
                description="Forte chaleur ! Les clients recherchent des boissons fra√Æches et des plats l√©gers.",
                category=EventCategory.WEATHER,
                probability=0.15,
                duration=3,
                demand_multiplier=Decimal("1.25"),
                segment_effects={
                    "√©tudiants": Decimal("1.4"),
                    "familles": Decimal("1.3"),
                },
                season_required="√©t√©",
            ),
            RandomEvent(
                id="heavy_rain",
                title="üåßÔ∏è Pluie battante",
                description="Mauvais temps persistant. Les gens sortent moins et pr√©f√®rent rester chez eux.",
                category=EventCategory.WEATHER,
                probability=0.20,
                duration=2,
                demand_multiplier=Decimal("0.80"),
                season_required="automne",
            ),
            RandomEvent(
                id="snow_storm",
                title="‚ùÑÔ∏è Temp√™te de neige",
                description="Chutes de neige importantes. Circulation difficile, moins de clients.",
                category=EventCategory.WEATHER,
                probability=0.12,
                duration=2,
                demand_multiplier=Decimal("0.70"),
                season_required="hiver",
            ),
            # √âv√©nements √©conomiques
            RandomEvent(
                id="economic_crisis",
                title="üìâ Crise √©conomique",
                description="Difficult√©s √©conomiques. Les consommateurs deviennent tr√®s sensibles aux prix.",
                category=EventCategory.ECONOMIC,
                probability=0.08,
                duration=5,
                price_sensitivity=Decimal("1.6"),
                segment_effects={
                    "√©tudiants": Decimal("0.7"),
                    "familles": Decimal("0.8"),
                },
            ),
            RandomEvent(
                id="bonus_payment",
                title="üí∞ Prime exceptionnelle",
                description="Les salari√©s re√ßoivent une prime. Augmentation temporaire du pouvoir d'achat.",
                category=EventCategory.ECONOMIC,
                probability=0.15,
                duration=3,
                demand_multiplier=Decimal("1.20"),
                price_sensitivity=Decimal("0.85"),
            ),
            # √âv√©nements sociaux
            RandomEvent(
                id="local_festival",
                title="üé™ Festival local",
                description="Grand √©v√©nement culturel dans le quartier. Affluence exceptionnelle !",
                category=EventCategory.SOCIAL,
                probability=0.25,
                duration=2,
                demand_multiplier=Decimal("1.50"),
                segment_effects={"foodies": Decimal("1.8"), "familles": Decimal("1.4")},
            ),
            RandomEvent(
                id="transport_strike",
                title="üöá Gr√®ve des transports",
                description="Gr√®ve g√©n√©rale des transports. Difficult√©s pour venir au restaurant.",
                category=EventCategory.SOCIAL,
                probability=0.10,
                duration=1,
                demand_multiplier=Decimal("0.65"),
            ),
            RandomEvent(
                id="university_exams",
                title="üìö P√©riode d'examens",
                description="Examens universitaires. Les √©tudiants sortent moins mais commandent plus √† emporter.",
                category=EventCategory.SOCIAL,
                probability=0.30,
                duration=4,
                segment_effects={"√©tudiants": Decimal("0.6")},
                min_turn=3,
            ),
            # √âv√©nements de concurrence
            RandomEvent(
                id="new_competitor",
                title="üè™ Nouveau concurrent",
                description="Ouverture d'un nouveau restaurant dans le quartier. La concurrence s'intensifie.",
                category=EventCategory.COMPETITION,
                probability=0.06,
                duration=10,
                demand_multiplier=Decimal("0.85"),
                min_turn=5,
            ),
            RandomEvent(
                id="competitor_closure",
                title="üîí Fermeture concurrent",
                description="Un restaurant concurrent ferme d√©finitivement. Opportunit√© de r√©cup√©rer sa client√®le !",
                category=EventCategory.COMPETITION,
                probability=0.04,
                duration=999,  # Permanent
                demand_multiplier=Decimal("1.25"),
                min_turn=8,
            ),
            # √âv√©nements d'approvisionnement
            RandomEvent(
                id="meat_shortage",
                title="ü•© P√©nurie de viande",
                description="Probl√®mes d'approvisionnement en viande. Prix en hausse, qualit√© plus importante.",
                category=EventCategory.SUPPLY,
                probability=0.08,
                duration=4,
                quality_importance=Decimal("1.4"),
            ),
            RandomEvent(
                id="excellent_harvest",
                title="ü•¨ R√©colte exceptionnelle",
                description="Excellente r√©colte de l√©gumes locaux. Produits frais abondants et moins chers.",
                category=EventCategory.SUPPLY,
                probability=0.20,
                duration=6,
                quality_importance=Decimal("1.2"),
                season_required="automne",
            ),
            # √âv√©nements r√©glementaires
            RandomEvent(
                id="health_inspection",
                title="üîç Contr√¥le sanitaire",
                description="Inspection d'hygi√®ne dans le secteur. L'importance de la qualit√© est renforc√©e.",
                category=EventCategory.REGULATION,
                probability=0.18,
                duration=3,
                quality_importance=Decimal("1.5"),
            ),
            RandomEvent(
                id="tax_reduction",
                title="üìã R√©duction de charges",
                description="Baisse temporaire des charges sociales. Am√©lioration des marges pour tous.",
                category=EventCategory.REGULATION,
                probability=0.12,
                duration=8,
                demand_multiplier=Decimal("1.10"),
            ),
            # √âv√©nements sp√©ciaux
            RandomEvent(
                id="food_trend",
                title="üì± Nouvelle tendance culinaire",
                description="Buzz sur les r√©seaux sociaux autour d'un type de cuisine. Les foodies sont tr√®s actifs.",
                category=EventCategory.SOCIAL,
                probability=0.22,
                duration=5,
                segment_effects={"foodies": Decimal("1.6")},
                quality_importance=Decimal("1.3"),
            ),
            RandomEvent(
                id="celebrity_visit",
                title="‚≠ê Visite de c√©l√©brit√©",
                description="Une c√©l√©brit√© est aper√ßue dans le quartier. Effet de mode temporaire !",
                category=EventCategory.SOCIAL,
                probability=0.05,
                duration=2,
                demand_multiplier=Decimal("1.80"),
                segment_effects={"foodies": Decimal("2.2")},
            ),
        ]

    def process_turn(self, turn: int, season: str) -> list[RandomEvent]:
        """
        Traite les √©v√©nements pour un tour donn√©.

        Args:
            turn: Num√©ro du tour
            season: Saison actuelle

        Returns:
            Liste des nouveaux √©v√©nements d√©clench√©s
        """
        new_events = []

        # V√©rifier les √©v√©nements possibles
        for event_template in self.events_pool:
            # V√©rifier les conditions
            if not self._can_trigger(event_template, turn, season):
                continue

            # Test de probabilit√©
            if self.rng.random() < event_template.probability:
                # Cr√©er une instance de l'√©v√©nement
                event_instance = RandomEvent(
                    id=f"{event_template.id}_{turn}",
                    title=event_template.title,
                    description=event_template.description,
                    category=event_template.category,
                    probability=event_template.probability,
                    duration=event_template.duration,
                    demand_multiplier=event_template.demand_multiplier,
                    price_sensitivity=event_template.price_sensitivity,
                    quality_importance=event_template.quality_importance,
                    segment_effects=event_template.segment_effects.copy(),
                )

                new_events.append(event_instance)
                self.active_events.append(event_instance)

        # D√©cr√©menter la dur√©e des √©v√©nements actifs
        self._update_active_events()

        return new_events

    def _can_trigger(self, event: RandomEvent, turn: int, season: str) -> bool:
        """V√©rifie si un √©v√©nement peut se d√©clencher."""
        # V√©rifier le tour
        if not (event.min_turn <= turn <= event.max_turn):
            return False

        # V√©rifier la saison
        if event.season_required and season != event.season_required:
            return False

        # √âviter les doublons d'√©v√©nements similaires
        for active_event in self.active_events:
            if active_event.category == event.category and active_event.duration > 1:
                return False

        return True

    def _update_active_events(self):
        """Met √† jour la liste des √©v√©nements actifs."""
        expired_events = []

        for event in self.active_events:
            event.duration -= 1
            if event.duration <= 0:
                expired_events.append(event)
                self.event_history.append(event)

        # Supprimer les √©v√©nements expir√©s
        for event in expired_events:
            self.active_events.remove(event)

    def get_current_effects(self) -> dict[str, any]:
        """Retourne les effets cumul√©s des √©v√©nements actifs."""
        effects = {
            "demand_multiplier": Decimal("1.0"),
            "price_sensitivity": Decimal("1.0"),
            "quality_importance": Decimal("1.0"),
            "segment_effects": {},
        }

        for event in self.active_events:
            effects["demand_multiplier"] *= event.demand_multiplier
            effects["price_sensitivity"] *= event.price_sensitivity
            effects["quality_importance"] *= event.quality_importance

            # Effets par segment
            for segment, multiplier in event.segment_effects.items():
                if segment not in effects["segment_effects"]:
                    effects["segment_effects"][segment] = Decimal("1.0")
                effects["segment_effects"][segment] *= multiplier

        return effects

    def get_events_summary(self) -> dict[str, any]:
        """Retourne un r√©sum√© des √©v√©nements."""
        return {
            "active_events": [
                {
                    "title": event.title,
                    "description": event.description,
                    "category": event.category.value,
                    "remaining_turns": event.duration,
                }
                for event in self.active_events
            ],
            "total_active": len(self.active_events),
            "total_history": len(self.event_history),
        }

    def get_event_notification(self, event: RandomEvent) -> str:
        """G√©n√®re une notification pour un √©v√©nement."""
        category_icons = {
            EventCategory.WEATHER: "üå§Ô∏è",
            EventCategory.ECONOMIC: "üí∞",
            EventCategory.SOCIAL: "üë•",
            EventCategory.COMPETITION: "üè™",
            EventCategory.SUPPLY: "üì¶",
            EventCategory.REGULATION: "üìã",
        }

        icon = category_icons.get(event.category, "üì¢")

        notification = f"{icon} √âV√âNEMENT: {event.title}\n"
        notification += f"   {event.description}\n"
        notification += f"   Dur√©e: {event.duration} tour(s)\n"

        # Ajouter les effets principaux
        effects = []
        if event.demand_multiplier != Decimal("1.0"):
            change = (event.demand_multiplier - 1) * 100
            effects.append(f"Demande: {change:+.0f}%")

        if event.price_sensitivity != Decimal("1.0"):
            change = (event.price_sensitivity - 1) * 100
            effects.append(f"Sensibilit√© prix: {change:+.0f}%")

        if event.quality_importance != Decimal("1.0"):
            change = (event.quality_importance - 1) * 100
            effects.append(f"Importance qualit√©: {change:+.0f}%")

        if effects:
            notification += f"   Effets: {' | '.join(effects)}"

        return notification
